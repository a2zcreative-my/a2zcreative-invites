# Security Audit Notes

## Updated Controls
- **Download token entropy**: Tokens generated by `generateDownloadToken` now rely on `crypto.getRandomValues` instead of `Math.random`, making them resistant to prediction and brute-force guessing.
- **Payment method validation**: `handleCreatePayment` restricts `paymentMethod` to an allowlist (`billplz`, `duitnow`, `manual`), preventing unexpected gateway identifiers from being persisted or used in downstream logic.
- **Trusted audit attribution**: `handleVerifyPayment` now records `verified_by` using the authenticated administrator's ID rather than a client-supplied value, eliminating spoofing risk when approving payments.

## Follow-up Recommendations
- Add automated tests covering payment flows, including rejection of disallowed `paymentMethod` values.
- Consider persisting rate limits to durable storage (e.g., KV) to avoid resets between deployments and improve abuse prevention.
- Expand webhook verification to validate expected amounts and event ownership before upgrading access.
